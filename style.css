:root { --max-w: 100vmin; --pad: 16px; --anim-ms: 260ms; }
* { box-sizing: border-box; }
html, body { height:100%; margin:0; background:#000; color:#eee; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; overscroll-behavior:none; }
body, #app, #stage { touch-action:none; -webkit-user-select:none; user-select:none; }
#app { min-height:100%; display:grid; grid-template-rows:auto 1fr auto; }

.topbar { display:flex; justify-content:space-between; align-items:center; padding:var(--pad); background:#090909; border-bottom:1px solid #222; }
.brand { font-weight:700; letter-spacing:.5px; }
.build { opacity:.7; font-size:.9rem; }

#stage { position:relative; display:grid; place-items:center; padding:var(--pad); overflow:hidden; }
#anchorImg { max-width:min(100%, var(--max-w)); max-height:calc(100svh - 170px); object-fit:contain; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.65); will-change:transform, opacity; }

/* Compass grid overlay (drag direction) */
#compassGrid { position:absolute; inset:var(--pad); display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr; gap:0; pointer-events:none; opacity:.0; transition:opacity 160ms ease; }
#stage.dragging #compassGrid { opacity:.7; }
#compassGrid .cell { border:1px solid rgba(255,255,255,.07); position:relative; }
#compassGrid .cell[data-label]::after { content:attr(data-label); position:absolute; left:8px; top:8px; font-size:.9rem; opacity:.65; }
#compassGrid .cell.active { background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.18); }
#compassGrid .cell.c { background:rgba(255,255,255,.03); }

.controls { display:flex; gap:8px; padding:var(--pad); justify-content:center; flex-wrap:wrap; background:#090909; border-top:1px solid #222; }
.controls button { background:#1b1b1b; color:#eee; border:1px solid #2a2a2a; padding:10px 14px; border-radius:12px; font-size:.95rem; }
.controls button:active { transform:translateY(1px); }

.debug { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(20,20,20,.8); border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:.9rem; opacity:0; transition:opacity 180ms ease; pointer-events:none; }
.notfound { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(10,10,10,.85); border:1px solid #333; padding:12px; border-radius:10px; max-width:min(90vw, 780px); white-space:pre-wrap; font-size:.9rem; display:none; }

.floater { position:fixed; right:14px; bottom:14px; padding:10px 14px; border-radius:12px; border:1px solid #2a2a2a; background:#1b1b1b; color:#eee; z-index:30; }

/* Overlays shared */
.overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
.overlay.show { display:flex; }
.overlay .backdrop { position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(120%) blur(2px); }
.overlay .sheet { position:relative; z-index:1; width:min(960px, 94vw); background:#0f0f0f; border:1px solid #222; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.6); padding:16px; }
.sheet-head { display:flex; align-items:center; justify-content:space-between; }
.sheet-title { font-weight:700; font-size:1.05rem; }
.icon-btn { background:#1b1b1b; color:#eee; border:1px solid #2a2a2a; padding:6px 10px; border-radius:10px; }

/* Parents (dynamic 1 or 2 cards) */
.parents-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-top:12px; }
.parent-card { display:flex; flex-direction:column; gap:8px; align-items:center; background:#121212; border:1px solid #2a2a2a; padding:10px; border-radius:12px; }
.parent-card img { width:100%; max-height:46vh; object-fit:contain; border-radius:10px; }
.parent-card .label { opacity:.8; font-size:.95rem; }

/* Children (adaptive, no blanks) */
.children-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:12px; }
.child-card { display:flex; flex-direction:column; gap:6px; align-items:center; background:#121212; border:1px solid #2a2a2a; padding:10px; border-radius:12px; }
.child-card img { width:100%; max-height:28vh; object-fit:contain; border-radius:8px; }
.child-card .label { opacity:.85; font-size:.9rem; }

/* Drag & release animations */
.img-anim { transition: transform var(--anim-ms) ease, opacity var(--anim-ms) ease; }
.img-dragging { transition: none !important; }
.exit-left  { transform: translateX(-120%) scale(.98); opacity:.3; }
.exit-right { transform: translateX( 120%) scale(.98); opacity:.3; }
.exit-up    { transform: translateY(-120%) scale(.98); opacity:.3; }
.exit-down  { transform: translateY( 120%) scale(.98); opacity:.3; }
.enter-left  { transform: translateX(120%);  opacity:.3; }
.enter-right { transform: translateX(-120%); opacity:.3; }
.enter-up    { transform: translateY(120%);  opacity:.3; }
.enter-down  { transform: translateY(-120%); opacity:.3; }
.enter-done  { transform: none; opacity:1; }

@media (hover:none) and (pointer:coarse) { .controls { display:none; } }
@media (hover:hover) and (pointer:fine)   { .controls { display:flex; } }
